import {test} from 'node:test';
import assert from 'node:assert';

test('wasm exnref flag works in test mode', async () => {
  const codeBody = [
    0x00, 0x02, 0x7f, 0x02, 0x40, 0x1f, 0x7f, 0x01, 0x00, 0x00, 0x00, 0x41,
    0x2a, 0x0b, 0x0c, 0x01, 0x0b, 0x41, 0xe3, 0x00, 0x0b, 0x0b,
  ];
  const funcEntry = [codeBody.length, ...codeBody];
  const codeSection = [0x01, ...funcEntry];
  const bytes = new Uint8Array([
    0x00,
    0x61,
    0x73,
    0x6d,
    0x01,
    0x00,
    0x00,
    0x00,
    0x01,
    0x08,
    0x02,
    0x60,
    0x00,
    0x00,
    0x60,
    0x00,
    0x01,
    0x7f,
    0x03,
    0x02,
    0x01,
    0x01,
    0x0d,
    0x03,
    0x01,
    0x00,
    0x00,
    0x07,
    0x08,
    0x01,
    0x04,
    0x6d,
    0x61,
    0x69,
    0x6e,
    0x00,
    0x00,
    0x0a,
    codeSection.length,
    ...codeSection,
  ]);
  const mod = new WebAssembly.Module(bytes);
  const inst = new WebAssembly.Instance(mod);
  assert.strictEqual((inst.exports.main as () => number)(), 42);
});
