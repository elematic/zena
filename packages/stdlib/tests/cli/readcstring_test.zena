// Test string building from linear memory
//
// @requires: wasmtime

import {console} from 'zena:console-wasi';
import {Memory, defaultAllocator} from 'zena:memory';
import {String, Encoding} from 'zena:string';
import {newByteArray} from 'zena:byte-array';

let mem = Memory.default;
let alloc = defaultAllocator;

@external("wasi_snapshot_preview1", "proc_exit")
declare function __wasi_proc_exit(code: i32): void;

@external("wasi_snapshot_preview1", "args_sizes_get")
declare function __wasi_args_sizes_get(argcPtr: i32, argvBufSizePtr: i32): i32;

@external("wasi_snapshot_preview1", "args_get")
declare function __wasi_args_get(argvPtr: i32, argvBufPtr: i32): i32;

// Helper to allocate memory or panic
let allocOrPanic = (size: i32): i32 => {
  if (let (true, ptr) = alloc.alloc(size)) {
    return ptr;
  }
  __wasi_proc_exit(1);
  return 0;
};

// Read a null-terminated string from linear memory
let readCString = (ptr: i32): string => {
  var len = 0;
  while (mem.getU8(ptr + len) != 0) {
    len = len + 1;
  }
  
  let bytes = newByteArray(len);
  for (var i = 0; i < len; i = i + 1) {
    __byte_array_set(bytes, i, mem.getU8(ptr + i));
  }
  return String.fromByteArray(bytes, 0, len, Encoding.WTF8);
};

export let main = (): i32 => {
  console.log("Testing readCString...");
  
  // Get args
  let argcPtr = allocOrPanic(4);
  let argvBufSizePtr = allocOrPanic(4);
  
  var errno = __wasi_args_sizes_get(argcPtr, argvBufSizePtr);
  if (errno != 0) {
    console.log("args_sizes_get failed");
    return 1;
  }
  
  let argc = mem.getI32(argcPtr);
  let argvBufSize = mem.getI32(argvBufSizePtr);
  alloc.free(argcPtr);
  alloc.free(argvBufSizePtr);
  
  console.log("Got sizes");
  
  if (argc > 0) {
    let argvPtr = allocOrPanic(argc * 4);
    let argvBufPtr = allocOrPanic(argvBufSize);
    
    errno = __wasi_args_get(argvPtr, argvBufPtr);
    if (errno != 0) {
      console.log("args_get failed");
      return 1;
    }
    
    console.log("Got args, reading first...");
    
    let strPtr = mem.getI32(argvPtr);
    let arg = readCString(strPtr);
    console.log("First arg: " + arg);
    
    alloc.free(argvPtr);
    alloc.free(argvBufPtr);
  }
  
  return 0;
};
