// Math stdlib tests using zena:test
import {suite, test, TestContext} from 'zena:test';
import {equal} from 'zena:assert';
import {clz, ctz, popcnt, abs, neg, ceil, floor, trunc, nearest, sqrt, min, max, copysign, div, i32_trunc_s, i32_trunc_u, i64_trunc_s, i64_trunc_u} from 'zena:math';

export let tests = suite('zena:math', (): void => {
  // i32 bitwise operations
  test('clz i32', (ctx: TestContext): void => {
    equal(clz(0), 32);
    equal(clz(1), 31);
    equal(clz(-1), 0); // all 1s
  });

  test('ctz i32', (ctx: TestContext): void => {
    equal(ctz(0), 32);
    equal(ctz(1), 0);
    equal(ctz(8), 3); // 1000 in binary
  });

  test('popcnt i32', (ctx: TestContext): void => {
    equal(popcnt(0), 0);
    equal(popcnt(1), 1);
    equal(popcnt(3), 2); // 11 in binary
    equal(popcnt(-1), 32); // all 1s
  });

  // i64 bitwise operations
  test('clz i64', (ctx: TestContext): void => {
    equal(clz(0 as i64), 64 as i64);
    equal(clz(1 as i64), 63 as i64);
  });

  test('ctz i64', (ctx: TestContext): void => {
    equal(ctz(0 as i64), 64 as i64);
    equal(ctz(8 as i64), 3 as i64);
  });

  test('popcnt i64', (ctx: TestContext): void => {
    equal(popcnt(0 as i64), 0 as i64);
    equal(popcnt(-1 as i64), 64 as i64);
  });

  // f32 operations
  test('abs f32', (ctx: TestContext): void => {
    equal(abs(-1.5 as f32), 1.5 as f32);
    equal(abs(1.5 as f32), 1.5 as f32);
  });

  test('neg f32', (ctx: TestContext): void => {
    equal(neg(1.5 as f32), -1.5 as f32);
    equal(neg(-1.5 as f32), 1.5 as f32);
  });

  test('ceil f32', (ctx: TestContext): void => {
    equal(ceil(1.1 as f32), 2.0 as f32);
    equal(ceil(-1.1 as f32), -1.0 as f32);
  });

  test('floor f32', (ctx: TestContext): void => {
    equal(floor(1.9 as f32), 1.0 as f32);
    equal(floor(-1.1 as f32), -2.0 as f32);
  });

  test('trunc f32', (ctx: TestContext): void => {
    equal(trunc(1.9 as f32), 1.0 as f32);
    equal(trunc(-1.9 as f32), -1.0 as f32);
  });

  test('nearest f32', (ctx: TestContext): void => {
    equal(nearest(1.4 as f32), 1.0 as f32);
    equal(nearest(1.6 as f32), 2.0 as f32);
  });

  test('sqrt f32', (ctx: TestContext): void => {
    equal(sqrt(4.0 as f32), 2.0 as f32);
    equal(sqrt(9.0 as f32), 3.0 as f32);
  });

  test('min f32', (ctx: TestContext): void => {
    equal(min(1.0 as f32, 2.0 as f32), 1.0 as f32);
    equal(min(3.0 as f32, 2.0 as f32), 2.0 as f32);
  });

  test('max f32', (ctx: TestContext): void => {
    equal(max(1.0 as f32, 2.0 as f32), 2.0 as f32);
    equal(max(3.0 as f32, 2.0 as f32), 3.0 as f32);
  });

  test('copysign f32', (ctx: TestContext): void => {
    equal(copysign(1.0 as f32, -2.0 as f32), -1.0 as f32);
    equal(copysign(-1.0 as f32, 2.0 as f32), 1.0 as f32);
  });

  // f64 operations
  test('abs f64', (ctx: TestContext): void => {
    equal(abs(-1.5), 1.5);
    equal(abs(1.5), 1.5);
  });

  test('neg f64', (ctx: TestContext): void => {
    equal(neg(1.5), -1.5);
    equal(neg(-1.5), 1.5);
  });

  test('ceil f64', (ctx: TestContext): void => {
    equal(ceil(1.1), 2.0);
    equal(ceil(-1.1), -1.0);
  });

  test('floor f64', (ctx: TestContext): void => {
    equal(floor(1.9), 1.0);
    equal(floor(-1.1), -2.0);
  });

  test('trunc f64', (ctx: TestContext): void => {
    equal(trunc(1.9), 1.0);
    equal(trunc(-1.9), -1.0);
  });

  test('nearest f64', (ctx: TestContext): void => {
    equal(nearest(1.4), 1.0);
    equal(nearest(1.6), 2.0);
  });

  test('sqrt f64', (ctx: TestContext): void => {
    equal(sqrt(4.0), 2.0);
    equal(sqrt(9.0), 3.0);
  });

  test('min f64', (ctx: TestContext): void => {
    equal(min(1.0, 2.0), 1.0);
    equal(min(3.0, 2.0), 2.0);
  });

  test('max f64', (ctx: TestContext): void => {
    equal(max(1.0, 2.0), 2.0);
    equal(max(3.0, 2.0), 3.0);
  });

  test('copysign f64', (ctx: TestContext): void => {
    equal(copysign(1.0, -2.0), -1.0);
    equal(copysign(-1.0, 2.0), 1.0);
  });

  // Integer division
  test('div i32', (ctx: TestContext): void => {
    equal(div(10, 3), 3);
    equal(div(-10, 3), -3);
    equal(div(10, -3), -3);
    equal(div(-10, -3), 3);
    equal(div(0, 5), 0);
  });

  test('div i64', (ctx: TestContext): void => {
    equal(div(10 as i64, 3 as i64), 3 as i64);
    equal(div(-10 as i64, 3 as i64), -3 as i64);
    equal(div(10 as i64, -3 as i64), -3 as i64);
    equal(div(-10 as i64, -3 as i64), 3 as i64);
  });

  test('div u32', (ctx: TestContext): void => {
    equal(div(10 as u32, 3 as u32), 3 as u32);
    equal(div(0 as u32, 5 as u32), 0 as u32);
  });

  // Saturating float-to-int conversions (signed)
  test('i32_trunc_s f32 to i32', (ctx: TestContext): void => {
    equal(i32_trunc_s(1.9 as f32), 1);
    equal(i32_trunc_s(-1.9 as f32), -1);
    equal(i32_trunc_s(0.0 as f32), 0);
  });

  test('i32_trunc_s f64 to i32', (ctx: TestContext): void => {
    equal(i32_trunc_s(1.9), 1);
    equal(i32_trunc_s(-1.9), -1);
    equal(i32_trunc_s(0.0), 0);
  });

  test('i64_trunc_s f32 to i64', (ctx: TestContext): void => {
    equal(i64_trunc_s(1.9 as f32), 1 as i64);
    equal(i64_trunc_s(-1.9 as f32), -1 as i64);
    equal(i64_trunc_s(0.0 as f32), 0 as i64);
  });

  test('i64_trunc_s f64 to i64', (ctx: TestContext): void => {
    equal(i64_trunc_s(1.9), 1 as i64);
    equal(i64_trunc_s(-1.9), -1 as i64);
    equal(i64_trunc_s(0.0), 0 as i64);
  });

  // Saturating float-to-int conversions (unsigned)
  test('i32_trunc_u f32 to i32', (ctx: TestContext): void => {
    equal(i32_trunc_u(1.9 as f32), 1);
    equal(i32_trunc_u(0.0 as f32), 0);
    equal(i32_trunc_u(100.5 as f32), 100);
  });

  test('i32_trunc_u f64 to i32', (ctx: TestContext): void => {
    equal(i32_trunc_u(1.9), 1);
    equal(i32_trunc_u(0.0), 0);
    equal(i32_trunc_u(100.5), 100);
  });

  test('i64_trunc_u f32 to i64', (ctx: TestContext): void => {
    equal(i64_trunc_u(1.9 as f32), 1 as i64);
    equal(i64_trunc_u(0.0 as f32), 0 as i64);
    equal(i64_trunc_u(100.5 as f32), 100 as i64);
  });

  test('i64_trunc_u f64 to i64', (ctx: TestContext): void => {
    equal(i64_trunc_u(1.9), 1 as i64);
    equal(i64_trunc_u(0.0), 0 as i64);
    equal(i64_trunc_u(100.5), 100 as i64);
  });
});
