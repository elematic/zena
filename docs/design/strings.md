# String Implementation Design

## Overview

Strings in Zena are immutable sequences of UTF-8 bytes. They are implemented
using WASM GC arrays.

## Representation

- **WASM Type**: `(ref null $string)` where `$string` is defined as `(array
(mut i8))`. This type is exposed in Zena as `ByteArray`.
  - _Note_: While the WASM type definition uses `mut i8` to allow for
    efficient construction (e.g., concatenation), the language semantics
    enforce immutability. User code cannot modify string contents after
    creation.
- **Encoding**: UTF-8.

## Literals

String literals are stored in the WASM **Data Section**.

1.  **Compilation**: When the compiler encounters a string literal, it adds the
    UTF-8 bytes to a passive data segment in the WASM binary.
2.  **Runtime**: At runtime, a new array is allocated and initialized from the
    data segment using `array.new_data`.
3.  **Interning**: Currently, strings are **not interned** at runtime.
    - Evaluating the same literal multiple times (e.g., in a loop) creates
      distinct array objects (different references).
    - However, identical literals in the source code share the same underlying
      data segment in the binary to minimize binary size.

## Operations

### Concatenation (`+`)

Concatenation is implemented via a runtime helper function (generated by the
compiler) that:

1.  Calculates the total length of the new string.
2.  Allocates a new array of that length using `array.new_default`.
3.  Copies the bytes from the first string using `array.copy`.
4.  Copies the bytes from the second string using `array.copy`.

### Equality (`==`, `!=`)

Equality checks are implemented via a runtime helper function that performs
**value equality**:

1.  Checks if the references are identical (fast path).
2.  Checks if the lengths are equal.
3.  Iterates through the arrays and compares them byte-by-byte.

### Indexing (`str[i]`)

Indexing is compiled directly to the `array.get_u` instruction.

- Returns the byte value (`i32`) at the specified index.
- Traps if the index is out of bounds (handled by WASM engine).

### Length (`str.length`)

Length access is compiled directly to the `array.len` instruction.

## Future Considerations

- **Unicode Support**: Currently, indexing returns raw bytes. Future
  iterations should consider how to handle Unicode code points or grapheme
  clusters.
- **Single Quotes**: We may reserve single quotes `'` for character literals
  (code points) in the future, similar to Rust or C.
- **Interning**: Implementing runtime string interning could improve equality
  check performance but adds complexity (requires a global string table/map).
- **Multiple Implementations**: We might want to support multiple string
  implementations in the future, such as Ropes for efficient concatenation of
  large strings.
